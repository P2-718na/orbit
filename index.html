<!DOCTYPE html>
<html lang="en-US" encoding="utf8">
<head>
  <title>Orbit</title>
  <style type="text/css">
    #canvass {
      width: 100%;
      height: 100%;
      z-index: -1;
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>
<body>
  <div class="slidecontainer">
    <label for="dt">dt</label>
    <input type="range" min="1" max="50" value="1" class="slider" id="dt" onchange="reset()" name="dt"><br>
    <label for="w">w</label>
    <input type="int" min="0" max="100" value="100" class="slider" id="w" onchange="reset()" name="w">
    <label for="p">p</label>
    <input type="int" min="-300" max="300" value="10" cass="slider" id="p" onchange="reset()" name="p"><br>
    <label for="x">x</label>
    <input type="int" min="-300" max="300" value="200" class="slider" id="x" onchange="reset()" name="x">
  </div>
  <canvas class="dots" id="canvass">Your browser does not support canvas.</canvas>

 
</body>
<script type="text/javascript">
  time  = +new Date();
  let shitf = false;

    function drawLineWithArrows(ctx, x0,y0,x1,y1, strokeStyle = "#000000", lw = 1, aWidth = 5,aLength = 5, arrowStart = false ,arrowEnd = true){
    var dx=x1-x0;
    var dy=y1-y0;
    var angle=Math.atan2(dy,dx);
    var length=Math.sqrt(dx*dx+dy*dy);
    //
    let old = ctx.strokeStyle;
    let oldv = ctx.lineWidth;
    ctx.lineWidth = lw;

    ctx.strokeStyle = strokeStyle;
    ctx.translate(x0,y0);
    ctx.rotate(angle);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(length,0);
    if(arrowStart){
        ctx.moveTo(aLength,-aWidth);
        ctx.lineTo(0,0);
        ctx.lineTo(aLength,aWidth);
    }
    if(arrowEnd){
        ctx.moveTo(length-aLength,-aWidth);
        ctx.lineTo(length,0);
        ctx.lineTo(length-aLength,aWidth);
    }
    //
    ctx.stroke();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.strokeStyle = old;
    ctx.lineWidth = oldv;
}
 

  let E = 0
const r = (x, y, x2, y2) => {
  return Math.sqrt(Math.pow((x - x2), 2) + Math.pow((y - y2), 2))
}


let dt = 0.00001;
const frame_dt = 0.1;

// Setup the canvas element.
var canvas = document.getElementById("canvass")
var context = canvas.getContext("2d")

// Get drawing context
var c3 = canvas.getContext( '2d' );

// Set Canvas dimensions
canvas.width   = window.innerWidth;
canvas.height  = window.innerHeight;



let pause = false;

let x = 100;
let p = 2;
let m = 1;

let mx;
let mp;

let dot_x = 0;
let dot_p = 0;

let w = 0.5;


// Animate the Circle
function step() {
  if (Math.abs(x) > 10000 || Math.abs(p) > 10000)
    pause = true;


    // Oscillatore parabolico
  //dot_x = p/m;
  //dot_p = -w*w*x * m;

  //if (+new Date() - time > 1000) {
  //  time = +new Date()
  //  dot_p += 1000000;
  //}
  
  // iperbolico
  dot_x = p/m;
  dot_p = w*w*x * m;

  // controllo
  //  if (x > 200 ) {
  //  dot_p = -50
  //}
  //if (x < -200 ) {
  //  dot_p = 50
  //}
  


  x += dot_x * dt;
  p += dot_p * dt;


  // osc ip
  mx += -(mp / m) * dt;
  mp += -(w*w*mx * m) * dt;

// osc par
  //mx += -(mp / m) * dt;
  //mp += (w*w*mx * m) * dt;

}

function animate3() {
    ax = x + 500
    adot_x = 1;


    ap = p + 500;
    adot_p = 1

    requestAnimationFrame( animate3 );
    //drawLineWithArrows(c3, ax - x, 100, ax, 100, "#FFFFFF", 4, 5, 6)
    c3.clearRect( 0, 50 , canvas.width, 100 );

    if (pause) {
      return
    }

    //c3.clearRect( 0, 0 , canvas.width, canvas.height );

    mx1 = mx;
    mp1 = mp;

    c3.beginPath();

    //m
    c3.arc( ax, ap,  1, 0, Math.PI * 2, false  );
  
    //M

      for (i = 0; i <= frame_dt; i+= dt) {

      step()
    }


    // en osc ip
    E = p*p/2/m - m * w*w * x * x / 2;

    // Energia oscillatore parabolico
    //E = p*p/2/m + w*w * x * x / 2;




    c3.strokeStyle = "#" + (E < 0 ? - E + 255:E).toString(16).split(".")[0];
    //console.log("#" + E.toString(16));
    ax2 = x + 500
    ap2 = p + 500
    c3.lineTo(ax2, ap2)
    c3.stroke();




    c3.beginPath()
    c3.arc( mx1 + 500, mp1 + 500,  1, 0, Math.PI * 2, false  );
    c3.lineTo(mx + 500, mp + 500)
    c3.stroke()




    drawLineWithArrows(c3, 500, 100, ax, 100)
    //time = +new Date();
}

const reset = () => {

  console.log("reset")
  canvas.width   = window.innerWidth;
  canvas.height  = window.innerHeight;


  c3.clearRect( 0, 0 , canvas.width, canvas.height );
  //dt = document.getElementById("dt").value / 1000;

    // Starting Position
    x = 100;
    p = .1;

    w = +document.getElementById("w").value / 100;
    mp = p = +document.getElementById("p").value / 100;


    mx = x = +document.getElementById("x").value;

    //time = +new Date();


  }

  window.onresize = reset

  reset();
  animate3();

  function printMousePos(event) {
    pause = false
    if (event.clientY < 200) return;


    x =  event.clientX - 500
    mx = x;
    
    p =  event.clientY  - 500;
    mp = p

    
}
document.addEventListener("click", printMousePos);
</script>

</html>